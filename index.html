<html lang="en">
  <head>
    <title></title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <link rel="stylesheet" type="text/css" href="./css/style.css">
    <script type="module">
      import ShiftRegister from './js/shift-register.mjs';
      import { Clock } from './js/clock.mjs';
      import { Snare, Kick, HiHat, sampleLoader } from './js/instruments.mjs';

      async function main() {
        let containerDiv = document.getElementById('container');

        /* Setup Audio Context and Instruments */
        let context = new AudioContext();

        let hiHat;
        await sampleLoader('samples/hihat.wav', context, function(buffer) {
          hiHat = new HiHat(context, buffer);
        });
        let snare = new Snare(context);
        let kick = new Kick(context);

        let instruments = [
          { instrument: snare, display: 'Snare', value: 'snare' },
          { instrument: hiHat, display: 'Hi Hat', value: 'hiHat' },
          { instrument: kick, display: 'Kick', value: 'kick' }
        ];
        /* Setup instruments */

        function createBoxElement(index) {
          let boxDiv = document.createElement('div');
          boxDiv.classList.add('box');
          boxDiv.innerText = index + 1;

          let controlsDiv = document.createElement('div');
          controlsDiv.classList.add('control');

          let controlSelect = document.createElement('select');
          instruments.forEach(({ display, value }) => {
            let controlOption = document.createElement('option');
            controlOption.text = display;
            controlOption.value = value;
            controlSelect.appendChild(controlOption);
          });

          controlsDiv.appendChild(controlSelect);
          boxDiv.appendChild(controlsDiv);
          return boxDiv;
        }

        let shiftRegister = new ShiftRegister(8);

        let bitElements = [];
        shiftRegister.bitArray.forEach((bit, index) => {
          let boxDiv = createBoxElement(index);
          containerDiv.appendChild(boxDiv);
          bitElements.push(boxDiv);
        });

        let clock = new Clock({
          onTick() {
            bitElements.forEach((bitDiv, index) => {
              if (shiftRegister.bitArray[index] === 1) {
                let instrumentName = bitDiv.querySelector('.control > select').value
                let { instrument } = instruments.find(i => i['value'] === instrumentName);
                instrument.trigger(context.currentTime);

                bitDiv.classList.add('bit-on');
              } else {
                bitDiv.classList.remove('bit-on');
              }
            });

            shiftRegister.onTick();
          }
        });
        window.myClock = clock;

        document.getElementById('clock-start-stop').addEventListener('click', function() {
          if (!clock.isRunning) {
            clock.start();
          } else {
            clock.stop();
           }
         });

         document.getElementById('write-bit').addEventListener('click', function() {
           shiftRegister.writeBit();
         });

         document.getElementById('loop').addEventListener('click', function() {
           shiftRegister.looping = !shiftRegister.looping;
         });
      }


     /* I hate myself for building it this way */
     main();
    </script>
  </head>

  <body>
    <div id="container" class="container">
    </div>

    <div id="clock" class="box">0</div>

    <button id="clock-start-stop">Start / Stop</button>

    <button id="write-bit">Write Bit</button>

    <button id="loop">Loop</button>
  </body>
</html>
